name: Release (Tag)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

concurrency:
  group: release-tag-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${{ github.repository_owner }}/${{ github.event.repository.name }}-backend
  FRONTEND_IMAGE: ${{ github.repository_owner }}/${{ github.event.repository.name }}-frontend
  NODE_MAJOR: 22

jobs:
  test-backend:
    name: Test backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: backend

      - name: cargo test
        working-directory: backend
        run: cargo test -p api

      # 防止镜像/二进制意外启用 sqlite（本项目 Docker/CI 仅支持 Postgres）
      - name: Guard: backend must not enable sqlx sqlite
        working-directory: backend
        run: |
          python - <<'PY'
          import pathlib
          import sys
          import tomllib

          data = tomllib.loads(pathlib.Path("Cargo.toml").read_text(encoding="utf-8"))
          sqlx = (data.get("workspace") or {}).get("dependencies", {}).get("sqlx")
          features = (sqlx or {}).get("features", []) if isinstance(sqlx, dict) else []

          if any("sqlite" in str(feature) for feature in features):
              print("ERROR: sqlx sqlite feature detected in backend/Cargo.toml:", features)
              sys.exit(1)

          print("OK: sqlx sqlite not enabled")
          PY

  test-frontend:
    name: Test frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: npm ci
        working-directory: frontend
        run: npm ci

      - name: npm test
        working-directory: frontend
        run: npm test

      - name: npm run build
        working-directory: frontend
        run: npm run build

  docker:
    name: Build & push docker images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker meta (backend)
        id: meta_backend
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}-backend
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Docker meta (frontend)
        id: meta_frontend
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}-frontend
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Build & push (backend)
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta_backend.outputs.tags }}
          labels: ${{ steps.meta_backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push (frontend)
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          build-args: |
            API_PROXY_TARGET=http://backend:8001
          push: true
          tags: ${{ steps.meta_frontend.outputs.tags }}
          labels: ${{ steps.meta_frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  release-assets:
    name: Build & upload release assets
    runs-on: ${{ matrix.os }}
    needs: [test-backend, test-frontend]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_MAJOR }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build backend (release)
        working-directory: backend
        run: cargo build -p api --release

      - name: Build frontend (standalone)
        working-directory: frontend
        env:
          API_PROXY_TARGET: http://localhost:8001
        run: |
          npm ci
          npm run build

      - name: Determine version
        id: ver
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          if ($tag.StartsWith("v")) { $ver = $tag.Substring(1) } else { $ver = $tag }
          "version=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Determine node runtime version
        id: nodever
        shell: pwsh
        run: |
          $v = node -p "process.version"
          $v = $v.TrimStart("v")
          "node_version=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Stage dist (all platforms)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $root = (Get-Location).Path
          $stage = Join-Path $root "dist/fundval"
          if (Test-Path $stage) { Remove-Item -Recurse -Force $stage }
          New-Item -ItemType Directory -Path $stage | Out-Null

          # templates
          Copy-Item -Recurse -Force "packaging/templates/*" $stage

          # backend binary
          $backendBin = Join-Path $root "backend/target/release/api"
          if ($env:RUNNER_OS -eq "Windows") { $backendBin = "${backendBin}.exe" }
          $backendOut = Join-Path $stage ("fundval-backend" + ($(if ($env:RUNNER_OS -eq "Windows") { ".exe" } else { "" })))
          Copy-Item -Force $backendBin $backendOut

          # frontend standalone
          $frontendDir = Join-Path $stage "frontend"
          New-Item -ItemType Directory -Path $frontendDir | Out-Null
          Copy-Item -Recurse -Force "frontend/.next/standalone/*" $frontendDir
          New-Item -ItemType Directory -Path (Join-Path $frontendDir ".next") -Force | Out-Null
          Copy-Item -Recurse -Force "frontend/.next/static" (Join-Path $frontendDir ".next")
          Copy-Item -Recurse -Force "frontend/public" $frontendDir

          # writable dirs for portable
          New-Item -ItemType Directory -Path (Join-Path $stage "data") -Force | Out-Null

      - name: Bundle Node runtime (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $nodeVer = "${{ steps.nodever.outputs.node_version }}"
          $url = "https://nodejs.org/dist/v$nodeVer/node-v$nodeVer-win-x64.zip"
          Invoke-WebRequest -Uri $url -OutFile node.zip
          Expand-Archive -Path node.zip -DestinationPath node-extract -Force
          $nodeExe = Get-ChildItem -Path node-extract -Recurse -Filter node.exe | Select-Object -First 1
          if (-not $nodeExe) { throw "node.exe not found in archive" }
          New-Item -ItemType Directory -Path dist/fundval/node -Force | Out-Null
          Copy-Item -Force $nodeExe.FullName dist/fundval/node/node.exe

      - name: Bundle Node runtime (Linux)
        if: runner.os == 'Linux'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $nodeVer = "${{ steps.nodever.outputs.node_version }}"
          $url = "https://nodejs.org/dist/v$nodeVer/node-v$nodeVer-linux-x64.tar.xz"
          Invoke-WebRequest -Uri $url -OutFile node.tar.xz
          tar -xf node.tar.xz
          $nodeBin = Get-ChildItem -Path . -Recurse -Filter node | Where-Object { $_.FullName -match "node-v.*linux-x64.*/bin/node$" } | Select-Object -First 1
          if (-not $nodeBin) { throw "node binary not found in archive" }
          New-Item -ItemType Directory -Path dist/fundval/node/bin -Force | Out-Null
          Copy-Item -Force $nodeBin.FullName dist/fundval/node/bin/node
          chmod +x dist/fundval/node/bin/node
          chmod +x dist/fundval/start.sh

      - name: Bundle Node runtime (macOS)
        if: runner.os == 'macOS'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $nodeVer = "${{ steps.nodever.outputs.node_version }}"
          $arch = (uname -m).Trim()
          $flavor = if ($arch -eq "arm64") { "darwin-arm64" } else { "darwin-x64" }
          $url = "https://nodejs.org/dist/v$nodeVer/node-v$nodeVer-$flavor.tar.gz"
          Invoke-WebRequest -Uri $url -OutFile node.tar.gz
          tar -xzf node.tar.gz
          $nodeBin = Get-ChildItem -Path . -Recurse -Filter node | Where-Object { $_.FullName -match "node-v.*$flavor.*/bin/node$" } | Select-Object -First 1
          if (-not $nodeBin) { throw "node binary not found in archive" }
          New-Item -ItemType Directory -Path dist/fundval/node/bin -Force | Out-Null
          Copy-Item -Force $nodeBin.FullName dist/fundval/node/bin/node
          chmod +x dist/fundval/node/bin/node
          chmod +x dist/fundval/start.sh

      - name: Create portable archive (Windows zip)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ver = "${{ steps.ver.outputs.version }}"
          $out = "fundval-$ver-windows-x64-portable.zip"
          if (Test-Path $out) { Remove-Item -Force $out }
          Compress-Archive -Path dist/fundval/* -DestinationPath $out

      - name: Create portable archive (Linux/macOS tar.gz)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          ver="${{ steps.ver.outputs.version }}"
          os="$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')"
          arch="$(uname -m)"
          tar -czf "fundval-${ver}-${os}-${arch}-portable.tar.gz" -C dist fundval

      - name: Build Windows MSI (WiX)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ver = "${{ steps.ver.outputs.version }}"
          choco install wixtoolset -y
          $wixBin = "${env:ProgramFiles(x86)}\\WiX Toolset v3.11\\bin"
          if (-not (Test-Path $wixBin)) { $wixBin = "${env:ProgramFiles(x86)}\\WiX Toolset v3.14\\bin" }
          if (-not (Test-Path $wixBin)) { throw "WiX Toolset bin not found" }

          & "$wixBin\\heat.exe" dir "dist\\fundval" -cg FundvalComponents -dr INSTALLFOLDER -var var.SourceDir -gg -scom -sreg -srd -out "Harvested.wxs"
          & "$wixBin\\candle.exe" -nologo -dProductVersion=$ver -dSourceDir="dist\\fundval" "packaging\\windows\\wix\\Product.wxs" "Harvested.wxs"
          & "$wixBin\\light.exe" -nologo -ext WixUIExtension -o "fundval-$ver-windows-x64.msi" "Product.wixobj" "Harvested.wixobj"

      - name: Build Windows EXE installer (Inno Setup)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ver = "${{ steps.ver.outputs.version }}"
          choco install innosetup -y
          $iscc = "${env:ProgramFiles(x86)}\\Inno Setup 6\\ISCC.exe"
          if (-not (Test-Path $iscc)) { throw "ISCC.exe not found" }
          & $iscc "/DMyAppVersion=$ver" "/DSourceDir=dist\\fundval" "packaging\\windows\\inno\\setup.iss"
          if (-not (Test-Path "Fundval-Setup-$ver-x64.exe")) { throw "Inno output exe not found" }

      - name: Upload release assets (Windows)
        if: runner.os == 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: |
            fundval-${{ steps.ver.outputs.version }}-windows-x64-portable.zip
            fundval-${{ steps.ver.outputs.version }}-windows-x64.msi
            Fundval-Setup-${{ steps.ver.outputs.version }}-x64.exe

      - name: Upload release assets (Linux)
        if: runner.os == 'Linux'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: |
            fundval-${{ steps.ver.outputs.version }}-linux-*-portable.tar.gz

      - name: Upload release assets (macOS)
        if: runner.os == 'macOS'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: |
            fundval-${{ steps.ver.outputs.version }}-macos-*-portable.tar.gz
