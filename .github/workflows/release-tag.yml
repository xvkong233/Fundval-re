name: Release (Tag)

"on":
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

concurrency:
  group: release-tag-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${{ github.repository_owner }}/${{ github.event.repository.name }}-backend
  FRONTEND_IMAGE: ${{ github.repository_owner }}/${{ github.event.repository.name }}-frontend
  QUANT_IMAGE: ${{ github.repository_owner }}/${{ github.event.repository.name }}-quant-service
  NODE_MAJOR: 22

jobs:
  test-backend:
    name: Test backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install sqlite deps
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends libsqlite3-dev pkg-config

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: backend

      - name: cargo test
        working-directory: backend
        run: cargo test -p api

      # Guard sqlx features for both sqlite (local/dev) and postgres (docker/prod)
      - name: "Guard: backend sqlx drivers"
        working-directory: backend
        shell: bash
        run: |
          python - <<'PY'
          import pathlib
          import sys
          import tomllib

          data = tomllib.loads(pathlib.Path("Cargo.toml").read_text(encoding="utf-8"))
          sqlx = (data.get("workspace") or {}).get("dependencies", {}).get("sqlx")
          features = (sqlx or {}).get("features", []) if isinstance(sqlx, dict) else []

          required = {"runtime-tokio", "any", "postgres", "sqlite", "uuid", "chrono", "migrate", "rust_decimal"}
          missing = sorted(required - set(map(str, features)))
          if missing:
              print("ERROR: missing required sqlx features in backend/Cargo.toml")
              print("Missing:", missing)
              print("Actual:", features)
              sys.exit(1)

          print("OK: required sqlx features present:", sorted(required))
          PY

  test-frontend:
    name: Test frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_MAJOR }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: npm ci
        working-directory: frontend
        run: npm ci

      - name: npm test
        working-directory: frontend
        run: npm test

      - name: npm run build
        working-directory: frontend
        run: npm run build

  test-quant-service:
    name: Test quant-service
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: quant-service/pyproject.toml

      - name: pip install
        working-directory: quant-service
        run: |
          python -m pip install -U pip
          python -m pip install -e ".[dev]"

      - name: pytest
        working-directory: quant-service
        run: pytest -q

  docker:
    name: Build & push docker images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, test-quant-service]
    env:
      # 支持多种常见 secret 命名，避免“已配置但读取不到”
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME || secrets.DOCKERHUB_USER || secrets.DOCKER_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN || secrets.DOCKERHUB_ACCESS_TOKEN || secrets.DOCKER_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Docker Hub secrets
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${DOCKERHUB_USERNAME:-}" ] && [ -n "${DOCKERHUB_TOKEN:-}" ]; then
            echo "Docker Hub creds: set (will push docker.io images)"
          else
            echo "Docker Hub creds: missing (skip docker.io push)"
            echo "DOCKERHUB_USERNAME set? ${{ env.DOCKERHUB_USERNAME != '' }}"
            echo "DOCKERHUB_TOKEN set? ${{ env.DOCKERHUB_TOKEN != '' }}"
          fi

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        with:
          registry: docker.io
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Docker meta (backend)
        id: meta_backend
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Docker meta (backend, docker.io)
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        id: meta_backend_dockerhub
        uses: docker/metadata-action@v5
        with:
          images: |
            docker.io/${{ env.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}-backend
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Docker meta (frontend)
        id: meta_frontend
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Docker meta (frontend, docker.io)
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        id: meta_frontend_dockerhub
        uses: docker/metadata-action@v5
        with:
          images: |
            docker.io/${{ env.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}-frontend
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Docker meta (quant-service)
        id: meta_quant
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.QUANT_IMAGE }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Docker meta (quant-service, docker.io)
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        id: meta_quant_dockerhub
        uses: docker/metadata-action@v5
        with:
          images: |
            docker.io/${{ env.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}-quant-service
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Build & push (backend)
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta_backend.outputs.tags }}
          labels: ${{ steps.meta_backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push (backend, docker.io)
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta_backend_dockerhub.outputs.tags }}
          labels: ${{ steps.meta_backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push (frontend)
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          build-args: |
            API_PROXY_TARGET=http://backend:8001
          push: true
          tags: ${{ steps.meta_frontend.outputs.tags }}
          labels: ${{ steps.meta_frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push (frontend, docker.io)
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          build-args: |
            API_PROXY_TARGET=http://backend:8001
          push: true
          tags: ${{ steps.meta_frontend_dockerhub.outputs.tags }}
          labels: ${{ steps.meta_frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push (quant-service)
        uses: docker/build-push-action@v6
        with:
          context: ./quant-service
          file: ./quant-service/Dockerfile
          push: true
          tags: ${{ steps.meta_quant.outputs.tags }}
          labels: ${{ steps.meta_quant.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push (quant-service, docker.io)
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/build-push-action@v6
        with:
          context: ./quant-service
          file: ./quant-service/Dockerfile
          push: true
          tags: ${{ steps.meta_quant_dockerhub.outputs.tags }}
          labels: ${{ steps.meta_quant.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-release:
    name: Create GitHub Release (from CHANGELOG)
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, test-quant-service]
    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: ver
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          if ($tag.StartsWith("v")) { $ver = $tag.Substring(1) } else { $ver = $tag }
          "version=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Extract release notes from CHANGELOG.md
        shell: bash
        run: |
          set -euo pipefail
          python scripts/release/extract_changelog.py --version "${{ steps.ver.outputs.version }}" --input CHANGELOG.md --output release-notes.md
          echo "---- release-notes.md (first 60 lines) ----"
          sed -n '1,60p' release-notes.md

      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: release-notes.md
          generate_release_notes: false

  release-assets:
    name: Build & upload release assets
    runs-on: ${{ matrix.os }}
    needs: [test-backend, test-frontend, test-quant-service, create-release]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_MAJOR }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build backend (release)
        working-directory: backend
        run: cargo build -p api --release

      - name: Build frontend (standalone)
        working-directory: frontend
        env:
          API_PROXY_TARGET: http://localhost:8001
        run: |
          npm ci
          npm run build

      - name: Determine version
        id: ver
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          if ($tag.StartsWith("v")) { $ver = $tag.Substring(1) } else { $ver = $tag }
          "version=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          $base = $ver.Split("-")[0]
          $parts = $base.Split(".")
          while ($parts.Count -lt 4) { $parts += "0" }
          $wixVer = ($parts[0..3] -join ".")
          "wix_version=$wixVer" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Determine node runtime version
        id: nodever
        shell: pwsh
        run: |
          $v = node -p "process.version"
          $v = $v.TrimStart("v")
          "node_version=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Stage dist (all platforms)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $root = (Get-Location).Path
          $stage = Join-Path $root "dist/fundval"
          if (Test-Path $stage) { Remove-Item -Recurse -Force $stage }
          New-Item -ItemType Directory -Path $stage | Out-Null

          # templates
          Copy-Item -Recurse -Force "packaging/templates/*" $stage

          # backend binary
          $backendBin = Join-Path $root "backend/target/release/api"
          if ($env:RUNNER_OS -eq "Windows") { $backendBin = "${backendBin}.exe" }
          $backendOut = Join-Path $stage ("fundval-backend" + ($(if ($env:RUNNER_OS -eq "Windows") { ".exe" } else { "" })))
          Copy-Item -Force $backendBin $backendOut

          # frontend standalone
          $frontendDir = Join-Path $stage "frontend"
          New-Item -ItemType Directory -Path $frontendDir | Out-Null
          Copy-Item -Recurse -Force "frontend/.next/standalone/*" $frontendDir
          New-Item -ItemType Directory -Path (Join-Path $frontendDir ".next") -Force | Out-Null
          Copy-Item -Recurse -Force "frontend/.next/static" (Join-Path $frontendDir ".next")
          Copy-Item -Recurse -Force "frontend/public" $frontendDir

          # writable dirs for portable
          New-Item -ItemType Directory -Path (Join-Path $stage "data") -Force | Out-Null

      - name: Bundle Node runtime (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $nodeVer = "${{ steps.nodever.outputs.node_version }}"
          $url = "https://nodejs.org/dist/v$nodeVer/node-v$nodeVer-win-x64.zip"
          Invoke-WebRequest -Uri $url -OutFile node.zip
          Expand-Archive -Path node.zip -DestinationPath node-extract -Force
          $nodeExe = Get-ChildItem -Path node-extract -Recurse -Filter node.exe | Select-Object -First 1
          if (-not $nodeExe) { throw "node.exe not found in archive" }
          New-Item -ItemType Directory -Path dist/fundval/node -Force | Out-Null
          Copy-Item -Force $nodeExe.FullName dist/fundval/node/node.exe

      - name: Bundle Node runtime (Linux)
        if: runner.os == 'Linux'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $nodeVer = "${{ steps.nodever.outputs.node_version }}"
          $url = "https://nodejs.org/dist/v$nodeVer/node-v$nodeVer-linux-x64.tar.xz"
          Invoke-WebRequest -Uri $url -OutFile node.tar.xz
          tar -xf node.tar.xz
          $nodeBin = Get-ChildItem -Path . -Recurse -Filter node | Where-Object { $_.FullName -match "node-v.*linux-x64.*/bin/node$" } | Select-Object -First 1
          if (-not $nodeBin) { throw "node binary not found in archive" }
          New-Item -ItemType Directory -Path dist/fundval/node/bin -Force | Out-Null
          Copy-Item -Force $nodeBin.FullName dist/fundval/node/bin/node
          chmod +x dist/fundval/node/bin/node
          chmod +x dist/fundval/start.sh

      - name: Bundle Node runtime (macOS)
        if: runner.os == 'macOS'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $nodeVer = "${{ steps.nodever.outputs.node_version }}"
          $arch = (uname -m).Trim()
          $flavor = if ($arch -eq "arm64") { "darwin-arm64" } else { "darwin-x64" }
          $url = "https://nodejs.org/dist/v$nodeVer/node-v$nodeVer-$flavor.tar.gz"
          Invoke-WebRequest -Uri $url -OutFile node.tar.gz
          tar -xzf node.tar.gz
          $nodeBin = Get-ChildItem -Path . -Recurse -Filter node | Where-Object { $_.FullName -match "node-v.*$flavor.*/bin/node$" } | Select-Object -First 1
          if (-not $nodeBin) { throw "node binary not found in archive" }
          New-Item -ItemType Directory -Path dist/fundval/node/bin -Force | Out-Null
          Copy-Item -Force $nodeBin.FullName dist/fundval/node/bin/node
          chmod +x dist/fundval/node/bin/node
          chmod +x dist/fundval/start.sh

      - name: Create portable archive (Windows zip)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ver = "${{ steps.ver.outputs.version }}"
          $out = "fundval-$ver-windows-x64-portable.zip"
          if (Test-Path $out) { Remove-Item -Force $out }
          Compress-Archive -Path dist/fundval/* -DestinationPath $out

      - name: Create portable archive (Linux/macOS tar.gz)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          ver="${{ steps.ver.outputs.version }}"
          os="$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')"
          arch="$(uname -m)"
          tar -czf "fundval-${ver}-${os}-${arch}-portable.tar.gz" -C dist fundval

      - name: Build Windows MSI (WiX)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ver = "${{ steps.ver.outputs.version }}"
          $wixVer = "${{ steps.ver.outputs.wix_version }}"
          choco install wixtoolset -y
          $wixBin = "${env:ProgramFiles(x86)}\\WiX Toolset v3.11\\bin"
          if (-not (Test-Path $wixBin)) { $wixBin = "${env:ProgramFiles(x86)}\\WiX Toolset v3.14\\bin" }
          if (-not (Test-Path $wixBin)) { throw "WiX Toolset bin not found" }

          & "$wixBin\\heat.exe" dir "dist\\fundval" -cg FundvalComponents -dr INSTALLFOLDER -var var.SourceDir -gg -scom -sreg -srd -out "Harvested.wxs"
          & "$wixBin\\candle.exe" -nologo -dProductVersion=$wixVer -dSourceDir="dist\\fundval" "packaging\\windows\\wix\\Product.wxs" "Harvested.wxs"
          & "$wixBin\\light.exe" -nologo -ext WixUIExtension -o "fundval-$ver-windows-x64.msi" "Product.wixobj" "Harvested.wixobj"

      - name: Build Windows EXE installer (Inno Setup)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ver = "${{ steps.ver.outputs.version }}"
          choco install innosetup -y
          $iscc = "${env:ProgramFiles(x86)}\\Inno Setup 6\\ISCC.exe"
          if (-not (Test-Path $iscc)) { throw "ISCC.exe not found" }
          & $iscc "/DMyAppVersion=$ver" "/DSourceDir=dist\\fundval" "packaging\\windows\\inno\\setup.iss"
          if (-not (Test-Path "Fundval-Setup-$ver-x64.exe")) { throw "Inno output exe not found" }

      - name: Upload release assets (Windows)
        if: runner.os == 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          tag_name: ${{ github.ref_name }}
          files: |
            fundval-${{ steps.ver.outputs.version }}-windows-x64-portable.zip
            fundval-${{ steps.ver.outputs.version }}-windows-x64.msi
            Fundval-Setup-${{ steps.ver.outputs.version }}-x64.exe

      - name: Upload release assets (Linux)
        if: runner.os == 'Linux'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          tag_name: ${{ github.ref_name }}
          files: |
            fundval-${{ steps.ver.outputs.version }}-linux-*-portable.tar.gz

      - name: Upload release assets (macOS)
        if: runner.os == 'macOS'
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          tag_name: ${{ github.ref_name }}
          files: |
            fundval-${{ steps.ver.outputs.version }}-macos-*-portable.tar.gz
