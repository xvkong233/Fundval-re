# 系统管理 API

## 配置说明

系统配置通过 `config.json` 文件管理，支持以下配置项：

> 说明：当前仓库的后端实现为 Rust（axum/sqlx/Postgres），数据库连接以 `DATABASE_URL` 环境变量为准；
> `config.json` 主要用于保存系统初始化状态与少量运行参数（例如 `allow_register`、`estimate_cache_ttl`）。

### 配置项

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| port | integer | 8001 | 服务端口（仅用于兼容字段；实际监听端口由 `PORT` 环境变量控制） |
| db_type | string | "sqlite" | 兼容字段（当前实现不依赖该字段选择数据库） |
| db_config | object | {} | 数据库连接配置 |
| allow_register | boolean | false | 是否允许用户注册 |
| system_initialized | boolean | false | 系统是否已初始化 |
| debug | boolean | false | 调试模式 |
| estimate_cache_ttl | integer | 5 | 估值缓存 TTL（分钟） |

### 配置示例

```json
{
  "port": 8001,
  "db_type": "sqlite",
  "db_config": {},
  "allow_register": false,
  "system_initialized": false,
  "debug": false,
  "estimate_cache_ttl": 5
}
```

### 配置说明

- **estimate_cache_ttl**: 控制基金估值数据的缓存时间，单位为分钟。设置较短的时间可以获取更实时的估值数据，但会增加对数据源的请求频率。建议值：3-10 分钟。

---

## 1. 健康检查

### 接口信息

- **路径**: `/api/health/`
- **方法**: `GET`
- **认证**: 不需要
- **描述**: 检查系统健康状态

### 请求示例

```bash
curl http://localhost:8001/api/health/
```

### 响应示例

```json
{
  "status": "ok",
  "database": "connected",
  "system_initialized": false
}
```

### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| status | string | 系统状态，固定返回 "ok" |
| database | string | 数据库连接状态："connected" 或 "disconnected" |
| system_initialized | boolean | 系统是否已初始化 |

---

## 2. 验证 Bootstrap Key

### 接口信息

- **路径**: `/api/admin/bootstrap/verify`
- **方法**: `POST`
- **认证**: 不需要
- **描述**: 验证系统初始化密钥（仅未初始化时可用）

### 请求参数

```json
{
  "bootstrap_key": "生成的随机密钥"
}
```

### 响应示例

**成功：**
```json
{
  "valid": true,
  "message": "密钥验证成功"
}
```

**失败：**
```json
{
  "valid": false,
  "error": "密钥无效"
}
```

### 状态码

- `200` - 验证成功
- `400` - 密钥无效
- `410` - 系统已初始化，接口失效

---

## 3. 初始化系统

### 接口信息

- **路径**: `/api/admin/bootstrap/initialize`
- **方法**: `POST`
- **认证**: 需要 bootstrap_key
- **描述**: 创建管理员账户并完成系统初始化

### 请求参数

```json
{
  "bootstrap_key": "生成的随机密钥",
  "admin_username": "admin",
  "admin_password": "secure_password",
  "allow_register": false
}
```

### 响应示例

```json
{
  "message": "系统初始化成功",
  "admin_created": true
}
```

### 注意事项

- bootstrap_key 在系统启动时生成，输出到日志
- 初始化完成后，bootstrap_key 失效
- 初始化完成后，此接口返回 410 Gone
- 不能重复初始化

### 状态码

- `200` - 初始化成功
- `400` - 密钥无效或参数错误
- `410` - 系统已初始化，接口失效
