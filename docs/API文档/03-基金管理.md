# 基金管理 API

## 1. 基金列表

### 接口信息

- **路径**: `/api/funds/`
- **方法**: `GET`
- **认证**: 不需要
- **描述**: 获取基金列表（分页）

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| page | integer | 否 | 页码，默认 1 |
| page_size | integer | 否 | 每页数量，默认 20 |
| search | string | 否 | 搜索关键词（基金代码或名称） |
| fund_type | string | 否 | 基金类型过滤 |

### 响应示例

```json
{
  "count": 100,
  "results": [
    {
      "fund_code": "000001",
      "fund_name": "华夏成长混合",
      "fund_type": "混合型",
      "latest_nav": "1.2345",
      "latest_nav_date": "2026-02-11",
      "created_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

### 状态码

- `200` - 成功

---

## 2. 基金详情

### 接口信息

- **路径**: `/api/funds/{fund_code}/`
- **方法**: `GET`
- **认证**: 不需要
- **描述**: 获取基金详细信息

### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| fund_code | string | 基金代码 |

### 响应示例

```json
{
  "fund_code": "000001",
  "fund_name": "华夏成长混合",
  "fund_type": "混合型",
  "latest_nav": "1.2345",
  "latest_nav_date": "2026-02-11",
  "created_at": "2024-01-01T00:00:00Z"
}
```

### 状态码

- `200` - 成功
- `404` - 基金不存在

---

## 3. 获取基金估值

### 接口信息

- **路径**: `/api/funds/{fund_code}/estimate/`
- **方法**: `GET`
- **认证**: 不需要
- **描述**: 获取基金实时估值

### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| fund_code | string | 基金代码 |

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| source | string | 否 | 数据源名称，默认 `tiantian`（兼容别名：`eastmoney`） |

### 响应示例

```json
{
  "fund_code": "000001",
  "fund_name": "华夏成长混合",
  "estimate_nav": "1.2456",
  "estimate_growth": "0.90",
  "estimate_time": "2026-02-11T14:30:00"
}
```

### 状态码

- `200` - 成功
- `404` - 基金或数据源不存在
- `500` - 数据源获取失败

---

## 4. 批量获取基金估值

### 接口信息

- **路径**: `/api/funds/batch_estimate/`
- **方法**: `POST`
- **认证**: 不需要
- **描述**: 批量获取基金实时估值（带缓存）

### 请求体

```json
{
  "fund_codes": ["000001", "000002", "110022"]
}
```

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| fund_codes | array | 是 | 基金代码列表 |

### 响应示例

```json
{
  "000001": {
    "fund_code": "000001",
    "fund_name": "华夏成长混合",
    "estimate_nav": "1.2345",
    "estimate_growth": "1.23",
    "estimate_time": "2026-02-11T14:30:00Z",
    "yesterday_nav": "1.2200",
    "from_cache": true
  },
  "000002": {
    "fund_code": "000002",
    "fund_name": "华夏大盘精选",
    "estimate_nav": "2.3456",
    "estimate_growth": "-0.50",
    "estimate_time": "2026-02-11T14:30:00Z",
    "yesterday_nav": "2.3500",
    "from_cache": false
  },
  "999999": {
    "fund_code": "999999",
    "error": "基金不存在"
  }
}
```

### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| fund_code | string | 基金代码 |
| fund_name | string | 基金名称 |
| estimate_nav | string | 实时估值净值 |
| estimate_growth | string | 估值涨跌幅（%） |
| estimate_time | string | 估值更新时间（ISO-like 字符串；不同数据源可能无时区后缀） |
| from_cache | boolean | 是否来自缓存 |
| error | string | 错误信息（仅在失败时返回） |

### 缓存机制

- **缓存有效期**: 默认 5 分钟（可通过 `config.json` 中的 `estimate_cache_ttl` 配置）
- **缓存策略**:
  - 如果数据库中有估值数据且更新时间在 TTL 内，直接返回缓存数据（`from_cache: true`）
  - 如果缓存失效或无数据，从数据源获取并更新数据库（`from_cache: false`）
- **并发控制**: 最多 5 个线程并发请求外部 API
- **配置方式**: 在 `config.json` 中设置 `estimate_cache_ttl`（单位：分钟）

### 状态码

- `200` - 成功（部分基金失败时也返回 200，错误信息在响应体中）
- `400` - 缺少 fund_codes 参数

### 性能说明

- **首次请求**（缓存未命中）: ~1-2 秒（取决于外部 API 响应时间）
- **后续请求**（缓存命中）: ~100ms（数据库查询）
- **建议**: 每页基金列表调用一次批量接口，避免逐个查询

---

## 5. 获取基金准确率

### 接口信息

- **路径**: `/api/funds/{fund_code}/accuracy/`
- **方法**: `GET`
- **认证**: 不需要
- **描述**: 获取基金各数据源的准确率统计

### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| fund_code | string | 基金代码 |

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| days | integer | 否 | 统计天数，默认 100 |

### 响应示例

```json
{
  "eastmoney": {
    "avg_error_rate": "0.0123",
    "record_count": 100,
    "records": [
      {
        "date": "2024-01-01",
        "error_rate": "0.0120"
      }
    ]
  },
  "tiantian": {
    "avg_error_rate": "0.0156",
    "record_count": 95,
    "records": [
      {
        "date": "2024-01-01",
        "error_rate": "0.0150"
      }
    ]
  }
}
```

### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| avg_error_rate | decimal | 平均误差率 |
| record_count | integer | 记录数量 |
| records | array | 每日误差率记录 |

### 状态码

- `200` - 成功
- `404` - 基金不存在

---

## 6. 查询持仓操作净值

### 接口信息

- **路径**: `/api/funds/query_nav/`
- **方法**: `POST`
- **认证**: 不需要
- **描述**: 查询持仓操作（建仓/加仓/减仓）时的净值

### 请求体

```json
{
  "fund_code": "000001",
  "operation_date": "2024-01-15",
  "before_15": true
}
```

### 请求字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| fund_code | string | 是 | 基金代码 |
| operation_date | date | 是 | 操作日期（YYYY-MM-DD） |
| before_15 | boolean | 是 | 是否在 15:00 前操作 |

### 响应示例

```json
{
  "fund_code": "000001",
  "fund_name": "华夏成长混合",
  "nav": "1.2345",
  "nav_date": "2024-01-14",
  "source": "history"
}
```

### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| fund_code | string | 基金代码 |
| fund_name | string | 基金名称 |
| nav | decimal | 净值 |
| nav_date | date | 净值日期 |
| source | string | 数据来源（history: 历史净值, latest: 最新净值） |

### 查询逻辑

- **15:00 前操作**: 查询 T-1 日净值
- **15:00 后操作**: 查询 T 日净值
- **非交易日**: 自动往前找最近的交易日
- **数据缺失**: fallback 到 Fund.latest_nav

### 使用场景

- 前端加仓/减仓操作时自动查询净值
- 避免用户手动输入净值导致错误
- 自动处理交易日判断和数据 fallback

### 状态码

- `200` - 成功
- `400` - 参数错误（未来日期）
- `404` - 基金不存在或净值数据未找到

---

## 7. 批量更新基金净值

### 接口信息

- **路径**: `/api/funds/batch_update_nav/`
- **方法**: `POST`
- **认证**: 不需要
- **描述**: 批量更新基金最新净值

### 请求体

```json
{
  "fund_codes": ["000001", "000002", "110022"]
}
```

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| fund_codes | array | 是 | 基金代码列表 |

### 响应示例

```json
{
  "000001": {
    "fund_code": "000001",
    "latest_nav": "1.2200",
    "latest_nav_date": "2026-02-11"
  },
  "000002": {
    "fund_code": "000002",
    "latest_nav": "2.3500",
    "latest_nav_date": "2026-02-11"
  },
  "999999": {
    "fund_code": "999999",
    "error": "获取净值失败: 基金不存在"
  }
}
```

### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| fund_code | string | 基金代码 |
| latest_nav | string | 最新净值 |
| latest_nav_date | string | 最新净值日期（ISO 8601） |
| error | string | 错误信息（仅在失败时返回） |

### 并发控制

- 最多 5 个线程并发请求外部 API
- 适用于批量刷新持仓列表中的基金净值

### 状态码

- `200` - 成功（部分基金失败时也返回 200，错误信息在响应体中）
- `400` - 缺少 fund_codes 参数

### 使用场景

- 持仓列表加载时批量刷新净值
- 建仓/加仓/减仓后刷新基金数据
- 定时任务批量更新净值

---

## 8. 同步基金列表（管理员）

### 接口信息

- **路径**: `/api/funds/sync/`
- **方法**: `POST`
- **认证**: 需要（管理员）
- **描述**: 从数据源同步基金列表

### 请求头

```
Authorization: Bearer <access_token>
```

### 响应示例

```json
{
  "created": 50,
  "updated": 150,
  "total": 200
}
```

### 状态码

- `200` - 同步成功
- `401` - 未认证
- `403` - 无权限（非管理员）
- `500` - 同步失败
