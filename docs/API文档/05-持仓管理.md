# 持仓管理 API

## 1. 持仓列表

### 接口信息

- **路径**: `/api/positions/`
- **方法**: `GET`
- **认证**: 需要
- **描述**: 获取当前用户的所有持仓

### 请求头

```
Authorization: Bearer <access_token>
```

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| account | uuid | 否 | 按账户过滤 |

### 响应示例

```json
[
  {
    "id": "uuid-string",
    "account": "uuid-string",
    "account_name": "子账户1",
    "fund_code": "000001",
    "fund_name": "华夏成长混合",
    "fund_type": "混合型",
    "fund": {
      "fund_code": "000001",
      "fund_name": "华夏成长混合",
      "fund_type": "混合型",
      "latest_nav": "1.5000",
      "latest_nav_date": "2026-02-11",
      "estimate_nav": "1.6000",
      "estimate_growth": "6.6700",
      "estimate_time": "2026-02-12T14:30:00Z"
    },
    "holding_share": "1000.0000",
    "holding_cost": "12345.00",
    "holding_nav": "12.3450",
    "pnl": "123.45",
    "updated_at": "2024-01-02T00:00:00Z"
  }
]
```

### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 持仓 ID |
| account | uuid | 账户 ID |
| account_name | string | 账户名称 |
| fund_code | string | 基金代码（向后兼容） |
| fund_name | string | 基金名称（向后兼容） |
| fund_type | string | 基金类型（向后兼容） |
| fund | object | 基金详细信息（包含净值和估值） |
| fund.fund_code | string | 基金代码 |
| fund.fund_name | string | 基金名称 |
| fund.fund_type | string | 基金类型 |
| fund.latest_nav | string | 最新净值 |
| fund.latest_nav_date | string | 最新净值日期 |
| fund.estimate_nav | string | 实时估值净值 |
| fund.estimate_growth | string | 估值涨跌幅（%） |
| fund.estimate_time | string | 估值更新时间 |
| holding_share | decimal | 持有份额 |
| holding_cost | decimal | 持有成本 |
| holding_nav | decimal | 持仓平均净值 |
| pnl | decimal | 盈亏金额（基于最新净值） |
| updated_at | datetime | 更新时间 |

### 字段说明

- **fund 对象**: 包含基金的完整信息，包括最新净值和实时估值
- **向后兼容字段**: `fund_code`、`fund_name`、`fund_type` 保留用于向后兼容
- **建议使用**: 优先使用 `fund` 对象获取基金信息，包含更多数据

### 状态码

- `200` - 成功
- `401` - 未认证

---

## 2. 持仓详情

### 接口信息

- **路径**: `/api/positions/{id}/`
- **方法**: `GET`
- **认证**: 需要
- **描述**: 获取持仓详细信息

### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | uuid | 持仓 ID |

### 响应示例

```json
{
  "id": "uuid-string",
  "account": "uuid-string",
  "account_name": "子账户1",
  "fund_code": "000001",
  "fund_name": "华夏成长混合",
  "fund_type": "混合型",
  "fund": {
    "fund_code": "000001",
    "fund_name": "华夏成长混合",
    "fund_type": "混合型",
    "latest_nav": "1.5000",
    "latest_nav_date": "2026-02-11",
    "estimate_nav": "1.6000",
    "estimate_growth": "6.6700",
    "estimate_time": "2026-02-12T14:30:00Z"
  },
  "holding_share": "1000.0000",
  "holding_cost": "12345.00",
  "holding_nav": "12.3450",
  "pnl": "123.45",
  "updated_at": "2024-01-02T00:00:00Z"
}
```

### 状态码

- `200` - 成功
- `401` - 未认证
- `404` - 持仓不存在

---

## 3. 重算持仓（管理员）

### 接口信息

- **路径**: `/api/positions/recalculate/`
- **方法**: `POST`
- **认证**: 需要（管理员）
- **描述**: 根据操作流水重新计算持仓

### 请求参数

```json
{
  "account_id": "uuid-string"
}
```

### 请求字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| account_id | uuid | 否 | 指定账户 ID，不填则重算所有账户 |

### 响应示例

```json
{
  "message": "重算完成"
}
```

### 状态码

- `200` - 重算成功
- `401` - 未认证
- `403` - 无权限（非管理员）

---

## 4. 账户历史市值

### 接口信息

- **路径**: `/api/positions/history/`
- **方法**: `GET`
- **认证**: 需要
- **描述**: 获取指定子账户的历史市值与持仓成本曲线（按天）

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| account_id | uuid | 是 | 子账户 ID |
| days | int | 否 | 天数，默认 30（返回 `days + 今天` 条） |

### 响应示例

```json
[
  { "date": "2026-02-01", "value": 10000.0, "cost": 9500.0 },
  { "date": "2026-02-02", "value": 10200.0, "cost": 9500.0 }
]
```

### 状态码

- `200` - 成功
- `400` - 参数错误（缺少 `account_id` / 暂不支持父账户）
- `401` - 未认证
- `404` - 账户不存在或不属于当前用户

---

## 5. 操作流水列表

### 接口信息

- **路径**: `/api/positions/operations/`
- **方法**: `GET`
- **认证**: 需要
- **描述**: 获取持仓操作流水

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| account | uuid | 否 | 按账户过滤 |
| fund_code | string | 否 | 按基金代码过滤 |

### 响应示例

```json
[
  {
    "id": "uuid-string",
    "account": "uuid-string",
    "account_name": "子账户1",
    "fund_code": "000001",
    "fund_name": "华夏成长混合",
    "operation_type": "BUY",
    "operation_date": "2024-01-01",
    "before_15": true,
    "amount": "10000.00",
    "share": "800.0000",
    "nav": "12.5000",
    "created_at": "2024-01-01T10:00:00Z"
  }
]
```

### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 操作 ID |
| account | uuid | 账户 ID |
| account_name | string | 账户名称 |
| fund_code | string | 基金代码 |
| fund_name | string | 基金名称 |
| operation_type | string | 操作类型：BUY（建仓/加仓）、SELL（减仓） |
| operation_date | date | 操作日期 |
| before_15 | boolean | 是否 15:00 前操作 |
| amount | decimal | 金额 |
| share | decimal | 份额 |
| nav | decimal | 净值 |
| created_at | datetime | 创建时间 |

### 状态码

- `200` - 成功
- `401` - 未认证

---

## 6. 创建操作流水

### 接口信息

- **路径**: `/api/positions/operations/`
- **方法**: `POST`
- **认证**: 需要
- **描述**: 创建持仓操作记录（建仓/加仓/减仓）

### 请求参数

```json
{
  "account": "uuid-string",
  "fund_code": "000001",
  "operation_type": "BUY",
  "operation_date": "2024-01-01",
  "before_15": true,
  "amount": "10000.00",
  "share": "800.00",
  "nav": "12.50"
}
```

### 请求字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| account | uuid | 是 | 账户 ID（必须是子账户） |
| fund_code | string | 是 | 基金代码 |
| operation_type | string | 是 | 操作类型：BUY 或 SELL |
| operation_date | date | 是 | 操作日期（格式：YYYY-MM-DD） |
| before_15 | boolean | 是 | 是否 15:00 前操作 |
| amount | decimal | 是 | 金额 |
| share | decimal | 是 | 份额 |
| nav | decimal | 是 | 净值 |

### 自动重算持仓

**重要**: 创建操作后，系统会自动重新计算该账户和基金的持仓汇总数据。

- **自动触发**: 无需手动调用重算接口
- **计算逻辑**: 根据所有操作流水重新计算持仓份额、成本和平均净值
- **事务保证**: 操作创建和持仓重算在同一事务中完成

### 验证规则

- **基金代码**: 必须存在于系统中，否则返回 400 错误
- **账户类型**: 必须是子账户，父账户不能持仓
- **金额和份额**: 必须大于 0
- **操作日期**: 不能晚于当前日期

### 响应示例

```json
{
  "id": "uuid-string",
  "account": "uuid-string",
  "account_name": "子账户1",
  "fund_code": "000001",
  "fund_name": "华夏成长混合",
  "operation_type": "BUY",
  "operation_date": "2024-01-01",
  "before_15": true,
  "amount": "10000.00",
  "share": "800.0000",
  "nav": "12.5000",
  "created_at": "2024-01-01T10:00:00Z"
}
```

### 状态码

- `201` - 创建成功（持仓已自动重算）
- `400` - 参数错误（基金不存在、账户类型错误等）
- `401` - 未认证

---

## 7. 操作流水详情

### 接口信息

- **路径**: `/api/positions/operations/{id}/`
- **方法**: `GET`
- **认证**: 需要
- **描述**: 获取操作流水详情

### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | uuid | 操作 ID |

### 响应示例

```json
{
  "id": "uuid-string",
  "account": "uuid-string",
  "account_name": "子账户1",
  "fund_code": "000001",
  "fund_name": "华夏成长混合",
  "operation_type": "BUY",
  "operation_date": "2024-01-01",
  "before_15": true,
  "amount": "10000.00",
  "share": "800.0000",
  "nav": "12.5000",
  "created_at": "2024-01-01T10:00:00Z"
}
```

### 状态码

- `200` - 成功
- `401` - 未认证
- `404` - 操作不存在

---

## 8. 删除操作流水（管理员）

### 接口信息

- **路径**: `/api/positions/operations/{id}/`
- **方法**: `DELETE`
- **认证**: 需要（管理员）
- **描述**: 删除操作流水记录

### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | uuid | 操作 ID |

### 响应

无响应体

### 状态码

- `204` - 删除成功
- `401` - 未认证
- `403` - 无权限（非管理员）
- `404` - 操作不存在

### 注意事项

- **自动重算**: 删除操作后系统会自动重新计算持仓
- **权限要求**: 仅管理员可以删除操作
- **数据一致性**: 删除和重算在同一事务中完成
- **不可恢复**: 删除操作不可恢复，请谨慎操作
