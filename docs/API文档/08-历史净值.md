# 基金历史净值 API

## 1. 查询历史净值列表

### 接口信息

- **路径**: `/api/nav-history/`
- **方法**: `GET`
- **认证**: 不需要
- **描述**: 获取基金历史净值数据

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| fund_code | string | 否 | 基金代码 |
| start_date | date | 否 | 开始日期（YYYY-MM-DD） |
| end_date | date | 否 | 结束日期（YYYY-MM-DD） |
| source | string | 否 | 数据源名称，默认 `tiantian`（兼容别名：`eastmoney`） |

### 响应示例

```json
[
  {
    "id": "uuid-string",
    "fund_code": "000001",
    "fund_name": "华夏成长混合",
    "nav_date": "2024-01-01",
    "unit_nav": "1.2345",
    "accumulated_nav": "2.3456",
    "daily_growth": "0.9000",
    "created_at": "2024-01-02T00:00:00Z",
    "updated_at": "2024-01-02T00:00:00Z"
  }
]
```

### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 记录 ID |
| fund_code | string | 基金代码 |
| fund_name | string | 基金名称 |
| nav_date | date | 净值日期 |
| unit_nav | decimal | 单位净值 |
| accumulated_nav | decimal | 累计净值（可为空） |
| daily_growth | decimal | 日增长率（%，可为空） |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |

### 使用示例

```bash
# 查询所有历史净值
curl http://localhost:8001/api/nav-history/

# 查询指定基金
curl http://localhost:8001/api/nav-history/?fund_code=000001

# 查询指定日期范围
curl "http://localhost:8001/api/nav-history/?fund_code=000001&start_date=2024-01-01&end_date=2024-12-31"
```

### 状态码

- `200` - 成功

---

## 2. 获取单条历史净值

### 接口信息

- **路径**: `/api/nav-history/{id}/`
- **方法**: `GET`
- **认证**: 不需要
- **描述**: 获取指定 ID 的历史净值记录

### 路径参数

| 参数 | 类型 | 说明 |
|------|------|------|
| id | uuid | 记录 ID |

### 响应示例

```json
{
  "id": "uuid-string",
  "fund_code": "000001",
  "fund_name": "华夏成长混合",
  "nav_date": "2024-01-01",
  "unit_nav": "1.2345",
  "accumulated_nav": "2.3456",
  "daily_growth": "0.9000",
  "created_at": "2024-01-02T00:00:00Z",
  "updated_at": "2024-01-02T00:00:00Z"
}
```

### 状态码

- `200` - 成功
- `404` - 记录不存在

---

## 3. 批量查询历史净值

### 接口信息

- **路径**: `/api/nav-history/batch_query/`
- **方法**: `POST`
- **认证**: 不需要
- **描述**: 批量查询多个基金的历史净值

### 请求体

```json
{
  "fund_codes": ["000001", "000002"],
  "start_date": "2024-01-01",
  "end_date": "2024-12-31",
  "nav_date": "2024-06-01"
}
```

### 请求字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| fund_codes | array | 是 | 基金代码列表 |
| start_date | date | 否 | 开始日期（YYYY-MM-DD） |
| end_date | date | 否 | 结束日期（YYYY-MM-DD） |
| nav_date | date | 否 | 查询单日数据（与日期范围互斥） |

### 响应示例

```json
{
  "000001": [
    {
      "id": "uuid-string",
      "fund_code": "000001",
      "fund_name": "华夏成长混合",
      "nav_date": "2024-01-01",
      "unit_nav": "1.2345",
      "accumulated_nav": "2.3456",
      "daily_growth": "0.9000",
      "created_at": "2024-01-02T00:00:00Z",
      "updated_at": "2024-01-02T00:00:00Z"
    }
  ],
  "000002": [
    {
      "id": "uuid-string",
      "fund_code": "000002",
      "fund_name": "华夏大盘精选",
      "nav_date": "2024-01-01",
      "unit_nav": "2.3456",
      "accumulated_nav": "3.4567",
      "daily_growth": "1.2000",
      "created_at": "2024-01-02T00:00:00Z",
      "updated_at": "2024-01-02T00:00:00Z"
    }
  ]
}
```

### 使用场景

- **时间段查询**: 指定 `start_date` 和 `end_date`，获取时间段内的所有净值
- **单日查询**: 指定 `nav_date`，获取某一天的净值
- **全量查询**: 不指定日期参数，获取所有历史净值

### 使用示例

```bash
# 批量查询多个基金
curl -X POST http://localhost:8001/api/nav-history/batch_query/ \
  -H "Content-Type: application/json" \
  -d '{
    "fund_codes": ["000001", "000002"]
  }'

# 查询指定日期范围
curl -X POST http://localhost:8001/api/nav-history/batch_query/ \
  -H "Content-Type: application/json" \
  -d '{
    "fund_codes": ["000001"],
    "start_date": "2024-01-01",
    "end_date": "2024-12-31"
  }'

# 查询单日数据
curl -X POST http://localhost:8001/api/nav-history/batch_query/ \
  -H "Content-Type: application/json" \
  -d '{
    "fund_codes": ["000001", "000002"],
    "nav_date": "2024-06-01"
  }'
```

### 状态码

- `200` - 成功
- `400` - 缺少 fund_codes 参数

---

## 4. 同步历史净值

### 接口信息

- **路径**: `/api/nav-history/sync/`
- **方法**: `POST`
- **认证**: 分级认证（见下方说明）
- **描述**: 从数据源同步基金历史净值

### 权限说明

- **≤15 个基金**: 不需要认证，任何人都可以同步
- **>15 个基金**: 需要管理员权限

### 请求头（仅当同步 >15 个基金时需要）

```
Authorization: Bearer <access_token>
```

### 请求体

```json
{
  "fund_codes": ["000001", "000002"],
  "start_date": "2024-01-01",
  "end_date": "2024-12-31"
}
```

### 请求字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| fund_codes | array | 是 | 基金代码列表 |
| start_date | date | 否 | 开始日期（YYYY-MM-DD） |
| end_date | date | 否 | 结束日期（YYYY-MM-DD） |

### 响应示例

```json
{
  "000001": {
    "success": true,
    "count": 245
  },
  "000002": {
    "success": true,
    "count": 198
  }
}
```

### 响应字段

| 字段 | 类型 | 说明 |
|------|------|------|
| success | boolean | 是否同步成功 |
| count | integer | 新增/更新的记录数（成功时） |
| error | string | 错误信息（失败时） |

### 同步逻辑

- **增量同步**: 默认从最后一条记录的日期开始同步
- **指定范围**: 可通过 `start_date` 和 `end_date` 指定同步范围
- **数据更新**: 如果记录已存在（相同基金+日期），会更新净值数据

### 使用示例

```bash
# 同步单个基金（增量）
curl -X POST http://localhost:8001/api/nav-history/sync/ \
  -H "Content-Type: application/json" \
  -d '{
    "fund_codes": ["000001"]
  }'

# 同步指定日期范围
curl -X POST http://localhost:8001/api/nav-history/sync/ \
  -H "Content-Type: application/json" \
  -d '{
    "fund_codes": ["000001", "000002"],
    "start_date": "2024-01-01",
    "end_date": "2024-12-31"
  }'
```

### 状态码

- `200` - 成功（部分失败也返回 200，错误信息在响应体中）
- `400` - 缺少 fund_codes 参数
- `403` - 无权限（同步 >15 个基金但未认证或非管理员）

### 注意事项

- 同步操作可能需要较长时间，建议使用异步方式调用
- 大批量同步建议按批次调用，避免单次请求过大
- 支持 `source` 参数（`tiantian`/`danjuan`/`ths`），默认 `tiantian`

---

## 5. 说明

本仓库不提供 Django 的 `manage.py` 管理命令；历史净值同步请使用：

- `POST /api/nav-history/sync/`

## 数据说明

### 数据来源

历史净值数据支持多数据源（`tiantian`/`danjuan`/`ths`），包括：
- **单位净值**: 每日基金单位净值
- **累计净值**: 累计净值（部分基金可能没有）
- **日增长率**: 相对前一日的增长率（%）

### 数据更新

- **更新频率**: 每日更新（交易日）
- **更新时间**: 通常在交易日收盘后更新
- **历史数据**: 支持获取基金成立以来的所有历史净值

### 数据特点

- **只读**: 历史净值数据只能通过同步接口更新，不支持手动创建/修改/删除
- **唯一性**: 同一数据源 + 同一基金 + 同一日期只能有一条记录
- **排序**: 默认按日期倒序排列（最新的在前）

---

## 常见问题

### Q: 如何获取基金的全部历史净值？

A: 使用查询接口，只指定 `fund_code` 参数：

```bash
curl http://localhost:8001/api/nav-history/?fund_code=000001
```

### Q: 如何同步新基金的历史数据？

A: 使用同步接口：

```bash
curl -X POST http://localhost:8001/api/nav-history/sync/ \
  -H "Content-Type: application/json" \
  -d '{"fund_codes": ["000001"]}'
```

### Q: 如何更新已有的历史数据？

A: 使用同步接口，指定日期范围（`start_date/end_date`）即可。

### Q: 批量查询和单独查询有什么区别？

A:
- **单独查询** (`GET /api/nav-history/`): 适合查询单个基金（或按条件过滤）
- **批量查询** (`POST /api/nav-history/batch_query/`): 适合同时查询多个基金，返回字典格式

### Q: 同步操作会覆盖已有数据吗？

A: 会更新已有数据。如果某个日期的净值已存在，同步时会用新数据覆盖旧数据。

---

## 性能建议

1. **批量查询**: 需要查询多个基金时，使用 `batch_query` 接口，避免多次请求
2. **日期范围**: 查询时尽量指定日期范围，避免返回过多数据
3. **增量同步**: 定期运行同步命令，保持数据最新
4. **并发控制**: 如需同步大量基金，建议分批调用并在客户端做并发限制

---

## 错误码

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 404 | 记录不存在 |
| 500 | 服务器错误 |
