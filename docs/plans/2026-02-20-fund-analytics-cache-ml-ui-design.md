# 基金详情专业化 + 缓存分批爬取 + ML 预测信号 + 嗅探页重构（Design）

**日期：** 2026-02-20  
**状态：** 已确认口径（可进入实施计划）  

## 目标（Goals）

1) **基金详情页专业化**：补齐专业指标（夏普/索提诺/卡玛/最大回撤/波动率等）与“同类分位综合评分”的**性价比**展示。  
2) **数据缓存与爬取调度**：基金数据按周期分批爬取，优先覆盖自选与持仓，避免触发上游 API 封锁。  
3) **基于全量基金数据的预测信号**：给出“波段信号（偏高/中等/偏低）”“回撤抄底可能性”“神奇反转可能性”，并提供置信度与解释字段。  
4) **信息架构与 UI**：左侧移除“基金”入口；嗅探页新增“购买建议”板块并深度重构为数据密集型仪表盘。

## 非目标（Non-goals）

- 不承诺“收益提升”或“高准确率”，不提供直接买卖指令（仅给出概率/分桶/解释与风险提示）。
- 不在本阶段引入外部付费数据源（如 Wind）；若需要，将在后续版本单独评估合规与成本。

## 关键口径（已确认）

- **持有周期：两者都显示**
  - 自然日：用于费用/赎回费/服务费等制度阈值提醒
  - 交易日：用于收益、波动、回撤等统计与信号计算（5/20/60/120/252T）
- **性价比：同类分位综合评分**
  - “同类”优先按天天基金 H5 详情页的**关联板块**分组（`fund_relate_theme`，如“国防军工”）；缺失时回退到 `fund_type`
  - 同一基金可能命中多个关联板块：详情页需同时展示多板块评分，并给出**总览汇总**（取最强板块；评选时 `sample_size >= 100` 优先，否则回退到全体最强）
- **无风险利率：3 个月国债利率（rf）**
  - 直接从数据源爬取并缓存；缺失时使用最近可用值；仍缺失则回退到配置常数，避免页面指标中断
- **ML 训练：允许 Python**
  - 离线训练 + 线上推理（后端在线计算特征、读取模型产物推理并缓存）

## 指标与“性价比”定义

### 专业指标（按交易日窗口计算）

- 年化收益、年化波动率、最大回撤、回撤修复天数
- Sharpe（使用 3 个月国债利率 rf）、Sortino（下行波动）、Calmar（年化收益/最大回撤）
- 风险调整收益与分项拆解（可配置权重）

### 同类分位综合评分（0–100）

- 按 `fund_type` 分组，同一时间窗内对指标做分位（或 rank），形成分项得分：
  - 加分项：Sharpe/Sortino/Calmar、年化收益、收益回撤比
  - 扣分项：最大回撤、年化波动、极端回撤持续
- 汇总为总分并输出：
  - 总分（0–100）
  - 同类百分位（例：前 12%）
  - 分项解释（“为什么是这个分数”）

## 数据缓存与分批爬取（防封锁）

### 总体策略

- 前端请求：优先读缓存；缓存过期不阻断展示（返回旧值 + 标注更新时间）并异步刷新
- 后台调度：周期性捞取到期任务，按并发/QPS 限制执行；失败指数退避；自选/持仓优先

### 任务优先级（从高到低）

1. 自选（watchlists）  
2. 持仓（positions）  
3. 最近访问基金  
4. 其余基金：全量轮询（分桶/游标保证长期覆盖）

### 观测与可运维

- 命中率、队列长度、失败率、最近 24h 执行量、最近一次成功刷新时间
- 管理接口：手动触发一轮“自选优先刷新”、查看队列与错误详情

## ML 预测信号（面向展示与可解释）

### 预测目标（多任务/多周期）

- **波段信号（偏高/中等/偏低）**：定位当前“位置/拥挤度”而非直接预测收益（输出三档 + 置信度）
- **回撤抄底可能性**：在满足回撤条件下，未来 20T 正收益（或超阈值）概率
- **神奇反转可能性**：深回撤后未来 20T 最大反弹幅度达到阈值的概率

### 关键阈值（已确认）

- **位置分桶阈值（偏低/中等/偏高）**：`20% / 60% / 20%`
- **回撤触发集（用于训练与展示）**：按同类（关联板块）回撤深度分位，取**最深 20%**样本
- **标签口径**
  - 抄底成功：触发后未来窗口累计收益 `> 0`（分别计算 `5T/20T`）
  - 神奇反转：触发后未来窗口最大反弹：`20T >= +8%`，`5T >= +3%`

### 特征（优先可解释）

- 多窗口动量、均线偏离（z-score）、波动与下行波动、回撤深度与持续、波动聚集、近端收益分布统计
- 基金元信息：`fund_type`、规模区间等（以现有字段为限）
- rf：3 个月国债利率（窗口对齐）

### 训练与回测

- Walk-forward 时间序列切分，避免未来信息泄漏
- 评估：AUC、Brier、校准曲线、以及按信号分桶的回测曲线（仅展示，不承诺收益）
- 模型版本化与可回滚：每次训练生成新版本与训练报告

## UI 与信息架构

### 左侧导航

- 移除“基金”入口（不删除 `/funds` 页面与详情页路由）
- 基金入口通过：自选/持仓/嗅探结果/搜索链接进入详情页

### 基金详情页（新增区块）

- “专业概览”：KPI 卡 + 指标表 + 同类分位评分 + 更新时间与数据源
- “预测信号”：三类信号 + 概率/置信度 + 触发原因（解释字段）
- “持有周期建议”：自然日（费用阈值）与交易日（统计窗口）并列展示

### 嗅探页（深度重构）

参考设计系统：
- `design-system/fundval/MASTER.md`
- `design-system/fundval/pages/sniffer.md`

布局：12 栏高密度仪表盘  
- 左侧：筛选 + 结果表（列配置、密度切换、hover 高亮、tooltip）  
- 右侧：“购买建议”面板：聚合展示候选基金与建议分桶（买入/观望/回避），并给出解释与直达详情页入口

## 风险与合规提示

- 所有“建议/信号”均应标注“非投资建议”，并提供数据更新时间、来源与模型置信度。
- 爬取必须遵守上游接口限制与 robots/条款；需要在实现中加入限速、退避、失败熔断与日志。

